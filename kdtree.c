/* arvore_kd.c - Implementação completa de Árvore KD para Reconhecimento Facial */
#include <stdio.h>
#include <stdlib.h>
#include <float.h>
#include <string.h>
#include <assert.h>
#include <math.h>

#define TAM_VETOR 128
#define TAM_NOME 100
#define LIMITE_VIZINHOS 5

/* Estruturas de Dados */
typedef struct {
    float vetor[TAM_VETOR];
    char nome[TAM_NOME];
} Registro;

typedef struct No {
    void *dado;
    struct No *esquerda;
    struct No *direita;
} No;

typedef struct {
    double distancia;
    void *no;
} NoVizinho;

typedef struct {
    NoVizinho *vizinhos;
    int tamanho;
    int limite;
} ListaVizinhos;

typedef struct {
    No *raiz;
    int (*comparar)(void *, void *, int);
    double (*calcular_distancia)(void *, void *);
    int dimensoes;
    ListaVizinhos *lista_vizinhos;
} ArvoreKD;

/* Funções Auxiliares */
ListaVizinhos* criar_lista_vizinhos(int limite) {
    ListaVizinhos *lista = malloc(sizeof(ListaVizinhos));
    lista->vizinhos = malloc(sizeof(NoVizinho) * limite);
    lista->tamanho = 0;
    lista->limite = limite;
    return lista;
}

void liberar_lista_vizinhos(ListaVizinhos *lista) {
    if (!lista) return;
    free(lista->vizinhos);
    free(lista);
}

int indice_pai(int i) { return (i - 1) / 2; }
int indice_esquerdo(int i) { return 2 * i + 1; }
int indice_direito(int i) { return 2 * i + 2; }

void trocar_vizinhos(NoVizinho *x, NoVizinho *y) {
    NoVizinho temp = *x;
    *x = *y;
    *y = temp;
}

void ajustar_para_cima(ListaVizinhos *lista, int indice) {
    if (indice == 0) return;
    int pai = indice_pai(indice);
    if (lista->vizinhos[indice].distancia >= lista->vizinhos[pai].distancia) 
        return;
    trocar_vizinhos(&lista->vizinhos[indice], &lista->vizinhos[pai]);
    ajustar_para_cima(lista, pai);
}

void ajustar_para_baixo(ListaVizinhos *lista, int indice) {
    int menor = indice;
    int esq = indice_esquerdo(indice);
    int dir = indice_direito(indice);
    
    if (esq < lista->tamanho && lista->vizinhos[esq].distancia < lista->vizinhos[menor].distancia)
        menor = esq;
    if (dir < lista->tamanho && lista->vizinhos[dir].distancia < lista->vizinhos[menor].distancia)
        menor = dir;
    if (menor == indice) return;
    
    trocar_vizinhos(&lista->vizinhos[indice], &lista->vizinhos[menor]);
    ajustar_para_baixo(lista, menor);
}

void inserir_vizinho(ListaVizinhos *lista, NoVizinho *vizinho) {
    if (lista->tamanho >= lista->limite) {
        if (vizinho->distancia >= lista->vizinhos[0].distancia)
            return;
        
        lista->vizinhos[0] = *vizinho;
        ajustar_para_baixo(lista, 0);
        return;
    }
    
    lista->vizinhos[lista->tamanho] = *vizinho;
    ajustar_para_cima(lista, lista->tamanho);
    lista->tamanho++;
}

/* Funções Principais */
void* criar_registro(float *vetor, char *nome) {
    Registro *reg = malloc(sizeof(Registro));
    memcpy(reg->vetor, vetor, sizeof(float) * TAM_VETOR);
    strncpy(reg->nome, nome, TAM_NOME-1);
    reg->nome[TAM_NOME-1] = '\0';
    return reg;
}

int comparar_registros(void *a, void *b, int pos) {
    float x = ((Registro *)a)->vetor[pos];
    float y = ((Registro *)b)->vetor[pos];
    return (x > y) ? 1 : ((y > x) ? -1 : 0);
}

double calcular_distancia(void *a, void *b) {
    double soma = 0, diferenca;
    for (int i = 0; i < TAM_VETOR; i++) {
        diferenca = ((Registro *)a)->vetor[i] - ((Registro *)b)->vetor[i];
        soma += diferenca * diferenca;
    }
    return sqrt(soma);
}

void construir_arvore(ArvoreKD *arv, int (*comparar)(void *, void *, int),
                     double (*distancia)(void *, void *), int dim) {
    arv->raiz = NULL;
    arv->comparar = comparar;
    arv->calcular_distancia = distancia;
    arv->dimensoes = dim;
    arv->lista_vizinhos = criar_lista_vizinhos(LIMITE_VIZINHOS);
}

void _inserir_no(No **no, void *dado, int (*comparar)(void *, void *, int), 
                int profundidade, int dim) {
    if (*no == NULL) {
        *no = malloc(sizeof(No));
        (*no)->dado = dado;
        (*no)->esquerda = NULL;
        (*no)->direita = NULL;
        return;
    }
    
    int pos = profundidade % dim;
    if (comparar((*no)->dado, dado, pos) < 0)
        _inserir_no(&(*no)->direita, dado, comparar, profundidade + 1, dim);
    else
        _inserir_no(&(*no)->esquerda, dado, comparar, profundidade + 1, dim);
}

void inserir_na_arvore(ArvoreKD *arv, void *dado) {
    _inserir_no(&arv->raiz, dado, arv->comparar, 0, arv->dimensoes);
}

void _buscar_vizinhos(ArvoreKD *arv, No **atual, void *alvo, 
                     int profundidade, double *menor_dist, No **melhor) {
    if (*atual == NULL) return;
    
    double dist = arv->calcular_distancia((*atual)->dado, alvo);
    NoVizinho vizinho = {dist, *atual};
    inserir_vizinho(arv->lista_vizinhos, &vizinho);
    
    if (dist < *menor_dist) {
        *menor_dist = dist;
        *melhor = *atual;
    }
    
    int pos = profundidade % arv->dimensoes;
    int cmp = arv->comparar(alvo, (*atual)->dado, pos);
    
    No **lado_principal = (cmp < 0) ? &(*atual)->esquerda : &(*atual)->direita;
    No **lado_oposto = (cmp < 0) ? &(*atual)->direita : &(*atual)->esquerda;
    
    _buscar_vizinhos(arv, lado_principal, alvo, profundidade + 1, menor_dist, melhor);
    
    if (fabs(cmp) < *menor_dist)
        _buscar_vizinhos(arv, lado_oposto, alvo, profundidade + 1, menor_dist, melhor);
}

Registro buscar_vizinho_mais_proximo(ArvoreKD *arv, Registro alvo) {
    double menor_dist = DBL_MAX;
    No *melhor = NULL;
    arv->lista_vizinhos->tamanho = 0; // Resetar lista
    
    _buscar_vizinhos(arv, &arv->raiz, &alvo, 0, &menor_dist, &melhor);
    return *((Registro *)(melhor->dado));
}

void _liberar_arvore(No *no) {
    if (no == NULL) return;
    _liberar_arvore(no->esquerda);
    _liberar_arvore(no->direita);
    free(no->dado);
    free(no);
}

void liberar_arvore(ArvoreKD *arv) {
    _liberar_arvore(arv->raiz);
    liberar_lista_vizinhos(arv->lista_vizinhos);
    arv->raiz = NULL;
}

/* Testes */
void testar_construcao() {
    /* Preparação */
    ArvoreKD arv;
    No no1, no2;
  float vetorTeste1[] = {
-0.020173832774162292,
  -0.8703914880752563,
  -1.1826353073120117,
  0.7255622148513794,
  0.5173637866973877,
  0.1373075395822525,
  -1.045743703842163,
  1.22040855884552,
  0.21030279994010925,
  0.44130533933639526,
  0.5780856609344482,
  -0.49785327911376953,
  1.5255377292633057,
  -0.8393266201019287,
  0.1385902613401413,
  0.35802745819091797,
  1.1899206638336182,
  -0.7702871561050415,
  -1.8167965412139893,
  0.4751681685447693,
  0.7373123168945312,
  1.116547703742981,
  0.08884309977293015,
  1.8188282251358032,
  0.31525519490242004,
  -0.8897969722747803,
  0.20553389191627502,
  1.345138669013977,
  2.5602450370788574,
  1.0172200202941895,
  1.5616430044174194,
  0.655845582485199,
  -1.1621274948120117,
  -0.78327876329422,
  0.3732612729072571,
  -1.270108938217163,
  0.19388805329799652,
  -0.5891361236572266,
  -1.7554757595062256,
  0.9319220781326294,
  -1.3832749128341675,
  0.1847466379404068,
  1.643329381942749,
  -0.4312204420566559,
  0.9701691269874573,
  0.13703018426895142,
  3.1696085929870605,
  -2.1661105155944824,
  0.8465080857276917,
  -0.17667047679424286,
  -2.4068427085876465,
  0.11736638844013214,
  -1.0271966457366943,
  1.22939133644104,
  -1.8435946702957153,
  -0.18206681311130524,
  -1.4077248573303223,
  -0.18166281282901764,
  0.08817662298679352,
  1.1290196180343628,
  -0.4319593906402588,
  1.1581804752349854,
  2.288259744644165,
  -0.509311854839325,
  -0.9883720278739929,
  1.249409556388855,
  0.8765983581542969,
  3.557018756866455,
  0.9989145994186401,
  -1.912404179573059,
  -0.8648574352264404,
  1.465975046157837,
  -0.3757965564727783,
  0.5947338938713074,
  -0.9063407182693481,
  0.9067371487617493,
  -0.014795958995819092,
  -1.077595829963684,
  -0.34120285511016846,
  -0.5282810926437378,
  -0.30674639344215393,
  -0.2018871158361435,
  -0.7212645411491394,
  0.5334470272064209,
  -0.4969427287578583,
  -0.8223920464515686,
  -0.9749903678894043,
  -1.3281960487365723,
  0.04035194218158722,
  -0.7407965660095215,
  1.629154920578003,
  -0.7464722394943237,
  -0.39339831471443176,
  -0.6072177886962891,
  -0.2836889326572418,
  2.3836090564727783,
  -1.3295968770980835,
  1.133596420288086,
  1.8842918872833252,
  -0.18695272505283356,
  0.04573090374469757,
  0.7692636251449585,
  1.4768024682998657,
  -0.7381846308708191,
  -0.14144934713840485,
  1.006456971168518,
  -1.691109538078308,
  0.17360258102416992,
  -0.304205060005188,
  -0.8322111964225769,
  0.6068450212478638,
  -0.5223826766014099,
  1.0666394233703613,
  -1.5167608261108398,
  0.6936853528022766,
  0.30224400758743286,
  -0.8453936576843262,
  -0.4143819808959961,
  -1.0767120122909546,
  0.44435057044029236,
  0.6141935586929321,
  0.6232903003692627,
  0.22305206954479218,
  -0.20140889286994934,
  0.09459273517131805,
  -0.012647300958633423,
  -0.4000028371810913,
  -1.8567832708358765    };

    float vetorTeste2[] = {
-0.5551770925521851,
  1.2361831665039062,
  -0.14934885501861572,
  -1.0240651369094849,
  -1.1525774002075195,
  1.6763486862182617,
  -0.3603733479976654,
  1.4861631393432617,
  0.5340595245361328,
  -0.2733007073402405,
  0.7573849558830261,
  0.12016354501247406,
  -0.1400773525238037,
  -0.48259150981903076,
  -0.788027286529541,
  0.7207728028297424,
  -0.6737617254257202,
  -0.13600683212280273,
  0.3107392191886902,
  -0.9039871692657471,
  0.7289167642593384,
  0.2780055105686188,
  -0.7371448278427124,
  0.9516566395759583,
  -1.337789535522461,
  -1.1521223783493042,
  -1.3073968887329102,
  0.0664522722363472,
  -1.8108229637145996,
  -1.9059723615646362,
  -1.7655009031295776,
  0.5191376209259033,
  -0.2630191147327423,
  -0.7738355994224548,
  1.326629877090454,
  -0.8085336089134216,
  -0.4807581603527069,
  -0.6924636363983154,
  0.7008590698242188,
  -1.1678447723388672,
  -0.3194485604763031,
  -0.844934344291687,
  -0.4948044717311859,
  -0.6149359941482544,
  -0.7801646590232849,
  -0.4490165710449219,
  1.6451530456542969,
  -1.7637791633605957,
  1.8003275394439697,
  0.024915598332881927,
  -0.9565034508705139,
  0.8910549283027649,
  0.662002682685852,
  -2.3987019062042236,
  1.3387491703033447,
  0.9408544898033142,
  -1.3279236555099487,
  -1.108227252960205,
  -0.6354203820228577,
  2.0768015384674072,
  0.010551411658525467,
  0.7624021172523499,
  1.362971544265747,
  -0.44677233695983887,
  1.2212815284729004,
  0.46858686208724976,
  1.1433303356170654,
  1.9471163749694824,
  2.1040329933166504,
  1.0105911493301392,
  0.686878502368927,
  0.9175310134887695,
  -1.6715563535690308,
  -0.46216750144958496,
  0.8380706310272217,
  -0.16703477501869202,
  -2.2350404262542725,
  0.0029892176389694214,
  0.05729240924119949,
  -0.13274046778678894,
  2.3081698417663574,
  -2.1764144897460938,
  -0.11542494595050812,
  -0.19474400579929352,
  1.0821517705917358,
  0.207363098859787,
  -2.065600633621216,
  -0.49630486965179443,
  -0.8394088745117188,
  -1.287946105003357,
  2.029566764831543,
  -1.1247488260269165,
  -0.12837010622024536,
  0.6640596985816956,
  -0.3701154291629791,
  1.8956319093704224,
  -1.4232592582702637,
  1.750120759010315,
  0.28982284665107727,
  1.0072623491287231,
  -0.6669555306434631,
  -0.39296698570251465,
  -0.014094159007072449,
  -0.25061872601509094,
  -1.1772664785385132,
  -1.6926361322402954,
  -0.3921676278114319,
  0.031227294355630875,
  -2.996910810470581,
  0.9047223329544067,
  -0.3752706050872803,
  1.1989318132400513,
  0.24361874163150787,
  0.25697603821754456,
  -2.0338327884674072,
  -0.7474809885025024,
  0.5080317258834839,
  0.1768912374973297,
  -0.7955396771430969,
  1.8676466941833496,
  -0.4138105511665344,
  -1.0251389741897583,
  0.9771409630775452,
  0.8541696071624756,
  -0.28265684843063354,
  -0.6660466194152832,
  -0.22058457136154175,
  -0.24460570514202118    };
    
    no1.dado = criar_registro(vetorTeste1, "Messi");
    no2.dado = criar_registro(vetorTeste2, "Di Maria");
    
    /* Ação */
    construir_arvore(&arv, comparar_registros, calcular_distancia, 2);
    
    /* Verificação */
    assert(arv.raiz == NULL);
    assert(arv.dimensoes == 2);
    assert(comparar_registros(no1.dado, no2.dado, 0) == 1);
    assert(comparar_registros(no1.dado, no2.dado, 1) == 1);
    assert(strcpy(((Registro *)no1.dado)->nome, "Dourados"));
    assert(strcpy(((Registro *)no2.dado)->nome, "Campo Grande"));
    
    free(no1.dado);
    free(no2.dado);
    liberar_arvore(&arv);
}

void testar_busca() {
    ArvoreKD arv;
    construir_arvore(&arv, comparar_registros, calcular_distancia, 2);
    
   float vetor1[] = {
-0.7454698085784912,
  0.9691751003265381,
  -2.1180057525634766,
  0.439149409532547,
  1.1979581117630005,
  -1.4357572793960571,
  -1.8333091735839844,
  -0.233638733625412,
  -0.12940555810928345,
  0.15054406225681305,
  1.6893322467803955,
  -1.1752020120620728,
  -0.9058395028114319,
  -1.8999698162078857,
  1.9019972085952759,
  -0.08157046139240265,
  -1.837294578552246,
  -0.8203704953193665,
  -1.5565277338027954,
  -0.260267049074173,
  -0.06969261169433594,
  0.3924352824687958,
  1.2332676649093628,
  0.5910029411315918,
  -0.10019855201244354,
  -0.32261893153190613,
  -0.36230576038360596,
  1.6873809099197388,
  0.5958226323127747,
  0.7486122846603394,
  -0.7960890531539917,
  -0.9937888979911804,
  -0.030662965029478073,
  1.0246906280517578,
  0.8146608471870422,
  2.0125601291656494,
  -0.9063760042190552,
  -1.5064408779144287,
  -1.0067634582519531,
  -1.974783182144165,
  -0.4088665843009949,
  0.08937499672174454,
  -1.0703966617584229,
  -0.8560436964035034,
  0.7119535803794861,
  -1.8343576192855835,
  0.8133785724639893,
  0.10023471713066101,
  0.1254795789718628,
  0.4185754656791687,
  -0.7156614065170288,
  -0.8350635170936584,
  0.6460185647010803,
  1.3904316425323486,
  -1.8539113998413086,
  0.2811535596847534,
  -1.1680325269699097,
  -1.0686225891113281,
  -1.1185719966888428,
  0.48143288493156433,
  -0.8436536192893982,
  -0.2630073130130768,
  0.7811828255653381,
  -1.431444525718689,
  -0.8974684476852417,
  0.390752375125885,
  -0.6800053119659424,
  0.5989995002746582,
  0.8028317093849182,
  0.7323818206787109,
  1.200835108757019,
  -0.372109591960907,
  -1.1844242811203003,
  0.339525043964386,
  -1.238722562789917,
  0.26603901386260986,
  1.2622202634811401,
  0.21329160034656525,
  0.7285762429237366,
  -0.19134306907653809,
  0.06792917102575302,
  -0.8952863216400146,
  -0.4265817403793335,
  1.2831374406814575,
  1.8039641380310059,
  -1.0742360353469849,
  0.4038427472114563,
  0.12833715975284576,
  1.9602657556533813,
  -1.450330376625061,
  0.6420295834541321,
  0.18999719619750977,
  0.6581369042396545,
  2.2913527488708496,
  -0.8142167329788208,
  0.18865753710269928,
  -2.2761988639831543,
  0.14898784458637238,
  -1.6667366027832031,
  -0.16312925517559052,
  0.9225032329559326,
  -0.8004814982414246,
  1.028870701789856,
  -0.18258337676525116,
  1.8139156103134155,
  0.8679673075675964,
  0.2877657115459442,
  -1.48486328125,
  -1.3516826629638672,
  2.0018632411956787,
  0.9854527711868286,
  0.13704316318035126,
  -1.5662853717803955,
  1.1797609329223633,
  1.1696797609329224,
  0.17746558785438538,
  -0.8645015954971313,
  -2.04115629196167,
  -0.579984724521637,
  1.87491774559021,
  0.1993764042854309,
  0.2871790826320648,
  -0.06586498022079468,
  0.8779368996620178,
  0.7184355854988098,
  -0.2991158664226532,
  1.502914309501648,
  1.0294678211212158    };
    float vetor2[] = {
-0.13223136961460114,
  -0.23990407586097717,
  0.6369282007217407,
  0.5853354930877686,
  0.39126482605934143,
  0.6116772294044495,
  0.6302892565727234,
  1.2338364124298096,
  -0.3460693657398224,
  -0.40827351808547974,
  -0.9788320660591125,
  -0.8885164856910706,
  0.27303534746170044,
  1.5013624429702759,
  0.7403829097747803,
  -1.3264259099960327,
  -1.0569783449172974,
  0.6334120035171509,
  -0.9984025955200195,
  0.5679669976234436,
  -1.4426144361495972,
  1.2973763942718506,
  -1.3812776803970337,
  0.23165741562843323,
  -0.4998924136161804,
  1.0763009786605835,
  1.577130913734436,
  0.44408583641052246,
  0.6716989278793335,
  0.2040935456752777,
  0.08782902359962463,
  2.876051664352417,
  -0.4827090799808502,
  -0.34523147344589233,
  -0.32080110907554626,
  -2.922924757003784,
  1.4386208057403564,
  -3.040937900543213,
  0.39226624369621277,
  -1.6933637857437134,
  -1.3026083707809448,
  -0.8654190897941589,
  1.7134954929351807,
  0.018489815294742584,
  1.4650076627731323,
  1.1569480895996094,
  1.2874410152435303,
  -2.6691253185272217,
  -0.39473026990890503,
  0.4094187021255493,
  -0.3618280291557312,
  -0.22576011717319489,
  0.10327121615409851,
  0.36768007278442383,
  -1.0877634286880493,
  -1.0396721363067627,
  0.23144511878490448,
  -0.03882419317960739,
  -0.34646180272102356,
  0.09795785695314407,
  -0.12453122437000275,
  1.9949874877929688,
  1.6077840328216553,
  1.6123626232147217,
  -0.9648587107658386,
  1.5516016483306885,
  0.9525192975997925,
  -0.16212140023708344,
  1.6505532264709473,
  -0.5279263257980347,
  0.42092064023017883,
  -1.039710521697998,
  -0.015620995312929153,
  0.5533586144447327,
  -0.4542255699634552,
  0.09019783139228821,
  -0.47067737579345703,
  -1.8035259246826172,
  1.55585777759552,
  1.3195728063583374,
  1.3002439737319946,
  0.4966590106487274,
  -0.26751917600631714,
  1.091745138168335,
  0.25305962562561035,
  -1.18058443069458,
  0.44712933897972107,
  -0.30925941467285156,
  -0.12050153315067291,
  -1.3995620012283325,
  -1.2953895330429077,
  -0.29002898931503296,
  -3.094984292984009,
  -0.8294292688369751,
  0.35962384939193726,
  0.7556072473526001,
  -0.553226888179779,
  -0.5275902152061462,
  -0.14178481698036194,
  -0.998215913772583,
  -1.4161131381988525,
  -0.6012252569198608,
  -0.2269170880317688,
  0.5961374640464783,
  -0.3721177875995636,
  1.0206522941589355,
  -1.4242626428604126,
  -1.4711112976074219,
  -0.262595534324646,
  0.7633969187736511,
  0.4477297365665436,
  -1.2913414239883423,
  -0.3807891607284546,
  0.08185364305973053,
  -0.0682358667254448,
  0.8014775514602661,
  -1.5489996671676636,
  -0.08704912662506104,
  -0.8448396325111389,
  -0.04385014995932579,
  -0.5307382941246033,
  0.6042630672454834,
  0.9167484045028687,
  1.5368759632110596,
  -0.45169490575790405,
  0.2738032042980194,
  1.2272809743881226,
  -0.317440003156662    };
    float vetor3[] = {
-0.3535991907119751,
  1.0662809610366821,
  -0.8898217082023621,
  -0.6436508297920227,
  0.3423987329006195,
  1.176653265953064,
  0.17738687992095947,
  0.21244320273399353,
  1.3741987943649292,
  0.15821929275989532,
  -0.29508981108665466,
  0.15550950169563293,
  0.6814433336257935,
  -0.5440629720687866,
  1.072876214981079,
  1.0310821533203125,
  -0.44354382157325745,
  0.2793634533882141,
  -0.6619238257408142,
  0.6959922313690186,
  0.41609808802604675,
  1.3100446462631226,
  -0.2585935890674591,
  0.6382582187652588,
  -0.3292795717716217,
  1.2015470266342163,
  -0.4622674882411957,
  -1.3622119426727295,
  0.35321205854415894,
  -0.32767558097839355,
  -1.4885005950927734,
  -0.042790476232767105,
  -0.38068845868110657,
  -0.8024241924285889,
  1.8672897815704346,
  -0.2906646430492401,
  0.17917092144489288,
  0.29951348900794983,
  0.8934911489486694,
  -1.289463758468628,
  1.1058218479156494,
  1.0139093399047852,
  1.0844438076019287,
  -0.0038699358701705933,
  -0.1477040946483612,
  -1.0480988025665283,
  0.7323204278945923,
  -2.608987331390381,
  -0.15572527050971985,
  0.18203328549861908,
  0.23022404313087463,
  1.9856657981872559,
  0.4256010949611664,
  -3.2760345935821533,
  0.0025287773460149765,
  -0.44158247113227844,
  1.7577197551727295,
  -0.257972776889801,
  1.1209932565689087,
  0.0021343454718589783,
  2.180934429168701,
  0.7309090495109558,
  -0.5872331857681274,
  0.653664231300354,
  0.2528747022151947,
  0.4397200345993042,
  2.0666868686676025,
  -0.07369418442249298,
  0.6473726630210876,
  -0.8478050231933594,
  0.7306411266326904,
  -0.8271400928497314,
  -0.7943285703659058,
  -1.6404656171798706,
  2.4173223972320557,
  -0.19000527262687683,
  -1.2386829853057861,
  -0.5105698704719543,
  -0.924028754234314,
  -1.9275240898132324,
  1.3092221021652222,
  1.0568927526474,
  -0.8227399587631226,
  0.8739662766456604,
  -0.8961621522903442,
  0.05641985684633255,
  -0.17874988913536072,
  0.18749524652957916,
  -1.4533231258392334,
  -1.0818108320236206,
  -1.28984797000885,
  -0.15099747478961945,
  0.0027224458754062653,
  0.08262927830219269,
  -0.4399411678314209,
  0.3624599277973175,
  -0.6026498079299927,
  -0.8819885849952698,
  -1.6534063816070557,
  0.7488142848014832,
  -0.49156099557876587,
  -1.0897676944732666,
  -2.73345947265625,
  -0.6390168070793152,
  -0.2175721824169159,
  -0.9972476363182068,
  -0.4033828675746918,
  -0.6583819389343262,
  0.2150110900402069,
  2.965780258178711,
  -0.21930131316184998,
  1.6080384254455566,
  2.0252859592437744,
  0.9709938764572144,
  -1.1863458156585693,
  -0.9457880258560181,
  -1.985852599143982,
  -1.0547881126403809,
  -0.1447194516658783,
  1.4204373359680176,
  0.7865580916404724,
  -1.1852742433547974,
  0.7166091203689575,
  -0.2496117502450943,
  0.7502471804618835,
  -1.0103986263275146,
  2.0195279121398926,
  -1.0223921537399292    };
    float vetor4[] = {
-0.3535991907119751,
  1.0662809610366821,
  -0.8898217082023621,
  -0.6436508297920227,
  0.3423987329006195,
  1.176653265953064,
  0.17738687992095947,
  0.21244320273399353,
  1.3741987943649292,
  0.15821929275989532,
  -0.29508981108665466,
  0.15550950169563293,
  0.6814433336257935,
  -0.5440629720687866,
  1.072876214981079,
  1.0310821533203125,
  -0.44354382157325745,
  0.2793634533882141,
  -0.6619238257408142,
  0.6959922313690186,
  0.41609808802604675,
  1.3100446462631226,
  -0.2585935890674591,
  0.6382582187652588,
  -0.3292795717716217,
  1.2015470266342163,
  -0.4622674882411957,
  -1.3622119426727295,
  0.35321205854415894,
  -0.32767558097839355,
  -1.4885005950927734,
  -0.042790476232767105,
  -0.38068845868110657,
  -0.8024241924285889,
  1.8672897815704346,
  -0.2906646430492401,
  0.17917092144489288,
  0.29951348900794983,
  0.8934911489486694,
  -1.289463758468628,
  1.1058218479156494,
  1.0139093399047852,
  1.0844438076019287,
  -0.0038699358701705933,
  -0.1477040946483612,
  -1.0480988025665283,
  0.7323204278945923,
  -2.608987331390381,
  -0.15572527050971985,
  0.18203328549861908,
  0.23022404313087463,
  1.9856657981872559,
  0.4256010949611664,
  -3.2760345935821533,
  0.0025287773460149765,
  -0.44158247113227844,
  1.7577197551727295,
  -0.257972776889801,
  1.1209932565689087,
  0.0021343454718589783,
  2.180934429168701,
  0.7309090495109558,
  -0.5872331857681274,
  0.653664231300354,
  0.2528747022151947,
  0.4397200345993042,
  2.0666868686676025,
  -0.07369418442249298,
  0.6473726630210876,
  -0.8478050231933594,
  0.7306411266326904,
  -0.8271400928497314,
  -0.7943285703659058,
  -1.6404656171798706,
  2.4173223972320557,
  -0.19000527262687683,
  -1.2386829853057861,
  -0.5105698704719543,
  -0.924028754234314,
  -1.9275240898132324,
  1.3092221021652222,
  1.0568927526474,
  -0.8227399587631226,
  0.8739662766456604,
  -0.8961621522903442,
  0.05641985684633255,
  -0.17874988913536072,
  0.18749524652957916,
  -1.4533231258392334,
  -1.0818108320236206,
  -1.28984797000885,
  -0.15099747478961945,
  0.0027224458754062653,
  0.08262927830219269,
  -0.4399411678314209,
  0.3624599277973175,
  -0.6026498079299927,
  -0.8819885849952698,
  -1.6534063816070557,
  0.7488142848014832,
  -0.49156099557876587,
  -1.0897676944732666,
  -2.73345947265625,
  -0.6390168070793152,
  -0.2175721824169159,
  -0.9972476363182068,
  -0.4033828675746918,
  -0.6583819389343262,
  0.2150110900402069,
  2.965780258178711,
  -0.21930131316184998,
  1.6080384254455566,
  2.0252859592437744,
  0.9709938764572144,
  -1.1863458156585693,
  -0.9457880258560181,
  -1.985852599143982,
  -1.0547881126403809,
  -0.1447194516658783,
  1.4204373359680176,
  0.7865580916404724,
  -1.1852742433547974,
  0.7166091203689575,
  -0.2496117502450943,
  0.7502471804618835,
  -1.0103986263275146,
  2.0195279121398926,
  -1.0223921537399292    };
    float vetor5[] = {
-0.3535991907119751,
  1.0662809610366821,
  -0.8898217082023621,
  -0.6436508297920227,
  0.3423987329006195,
  1.176653265953064,
  0.17738687992095947,
  0.21244320273399353,
  1.3741987943649292,
  0.15821929275989532,
  -0.29508981108665466,
  0.15550950169563293,
  0.6814433336257935,
  -0.5440629720687866,
  1.072876214981079,
  1.0310821533203125,
  -0.44354382157325745,
  0.2793634533882141,
  -0.6619238257408142,
  0.6959922313690186,
  0.41609808802604675,
  1.3100446462631226,
  -0.2585935890674591,
  0.6382582187652588,
  -0.3292795717716217,
  1.2015470266342163,
  -0.4622674882411957,
  -1.3622119426727295,
  0.35321205854415894,
  -0.32767558097839355,
  -1.4885005950927734,
  -0.042790476232767105,
  -0.38068845868110657,
  -0.8024241924285889,
  1.8672897815704346,
  -0.2906646430492401,
  0.17917092144489288,
  0.29951348900794983,
  0.8934911489486694,
  -1.289463758468628,
  1.1058218479156494,
  1.0139093399047852,
  1.0844438076019287,
  -0.0038699358701705933,
  -0.1477040946483612,
  -1.0480988025665283,
  0.7323204278945923,
  -2.608987331390381,
  -0.15572527050971985,
  0.18203328549861908,
  0.23022404313087463,
  1.9856657981872559,
  0.4256010949611664,
  -3.2760345935821533,
  0.0025287773460149765,
  -0.44158247113227844,
  1.7577197551727295,
  -0.257972776889801,
  1.1209932565689087,
  0.0021343454718589783,
  2.180934429168701,
  0.7309090495109558,
  -0.5872331857681274,
  0.653664231300354,
  0.2528747022151947,
  0.4397200345993042,
  2.0666868686676025,
  -0.07369418442249298,
  0.6473726630210876,
  -0.8478050231933594,
  0.7306411266326904,
  -0.8271400928497314,
  -0.7943285703659058,
  -1.6404656171798706,
  2.4173223972320557,
  -0.19000527262687683,
  -1.2386829853057861,
  -0.5105698704719543,
  -0.924028754234314,
  -1.9275240898132324,
  1.3092221021652222,
  1.0568927526474,
  -0.8227399587631226,
  0.8739662766456604,
  -0.8961621522903442,
  0.05641985684633255,
  -0.17874988913536072,
  0.18749524652957916,
  -1.4533231258392334,
  -1.0818108320236206,
  -1.28984797000885,
  -0.15099747478961945,
  0.0027224458754062653,
  0.08262927830219269,
  -0.4399411678314209,
  0.3624599277973175,
  -0.6026498079299927,
  -0.8819885849952698,
  -1.6534063816070557,
  0.7488142848014832,
  -0.49156099557876587,
  -1.0897676944732666,
  -2.73345947265625,
  -0.6390168070793152,
  -0.2175721824169159,
  -0.9972476363182068,
  -0.4033828675746918,
  -0.6583819389343262,
  0.2150110900402069,
  2.965780258178711,
  -0.21930131316184998,
  1.6080384254455566,
  2.0252859592437744,
  0.9709938764572144,
  -1.1863458156585693,
  -0.9457880258560181,
  -1.985852599143982,
  -1.0547881126403809,
  -0.1447194516658783,
  1.4204373359680176,
  0.7865580916404724,
  -1.1852742433547974,
  0.7166091203689575,
  -0.2496117502450943,
  0.7502471804618835,
  -1.0103986263275146,
  2.0195279121398926,
  -1.0223921537399292    };
    float vetor6[] = {
-0.3535991907119751,
  1.0662809610366821,
  -0.8898217082023621,
  -0.6436508297920227,
  0.3423987329006195,
  1.176653265953064,
  0.17738687992095947,
  0.21244320273399353,
  1.3741987943649292,
  0.15821929275989532,
  -0.29508981108665466,
  0.15550950169563293,
  0.6814433336257935,
  -0.5440629720687866,
  1.072876214981079,
  1.0310821533203125,
  -0.44354382157325745,
  0.2793634533882141,
  -0.6619238257408142,
  0.6959922313690186,
  0.41609808802604675,
  1.3100446462631226,
  -0.2585935890674591,
  0.6382582187652588,
  -0.3292795717716217,
  1.2015470266342163,
  -0.4622674882411957,
  -1.3622119426727295,
  0.35321205854415894,
  -0.32767558097839355,
  -1.4885005950927734,
  -0.042790476232767105,
  -0.38068845868110657,
  -0.8024241924285889,
  1.8672897815704346,
  -0.2906646430492401,
  0.17917092144489288,
  0.29951348900794983,
  0.8934911489486694,
  -1.289463758468628,
  1.1058218479156494,
  1.0139093399047852,
  1.0844438076019287,
  -0.0038699358701705933,
  -0.1477040946483612,
  -1.0480988025665283,
  0.7323204278945923,
  -2.608987331390381,
  -0.15572527050971985,
  0.18203328549861908,
  0.23022404313087463,
  1.9856657981872559,
  0.4256010949611664,
  -3.2760345935821533,
  0.0025287773460149765,
  -0.44158247113227844,
  1.7577197551727295,
  -0.257972776889801,
  1.1209932565689087,
  0.0021343454718589783,
  2.180934429168701,
  0.7309090495109558,
  -0.5872331857681274,
  0.653664231300354,
  0.2528747022151947,
  0.4397200345993042,
  2.0666868686676025,
  -0.07369418442249298,
  0.6473726630210876,
  -0.8478050231933594,
  0.7306411266326904,
  -0.8271400928497314,
  -0.7943285703659058,
  -1.6404656171798706,
  2.4173223972320557,
  -0.19000527262687683,
  -1.2386829853057861,
  -0.5105698704719543,
  -0.924028754234314,
  -1.9275240898132324,
  1.3092221021652222,
  1.0568927526474,
  -0.8227399587631226,
  0.8739662766456604,
  -0.8961621522903442,
  0.05641985684633255,
  -0.17874988913536072,
  0.18749524652957916,
  -1.4533231258392334,
  -1.0818108320236206,
  -1.28984797000885,
  -0.15099747478961945,
  0.0027224458754062653,
  0.08262927830219269,
  -0.4399411678314209,
  0.3624599277973175,
  -0.6026498079299927,
  -0.8819885849952698,
  -1.6534063816070557,
  0.7488142848014832,
  -0.49156099557876587,
  -1.0897676944732666,
  -2.73345947265625,
  -0.6390168070793152,
  -0.2175721824169159,
  -0.9972476363182068,
  -0.4033828675746918,
  -0.6583819389343262,
  0.2150110900402069,
  2.965780258178711,
  -0.21930131316184998,
  1.6080384254455566,
  2.0252859592437744,
  0.9709938764572144,
  -1.1863458156585693,
  -0.9457880258560181,
  -1.985852599143982,
  -1.0547881126403809,
  -0.1447194516658783,
  1.4204373359680176,
  0.7865580916404724,
  -1.1852742433547974,
  0.7166091203689575,
  -0.2496117502450943,
  0.7502471804618835,
  -1.0103986263275146,
  2.0195279121398926,
  -1.0223921537399292    };
    float vetor7[] = {
-0.3535991907119751,
  1.0662809610366821,
  -0.8898217082023621,
  -0.6436508297920227,
  0.3423987329006195,
  1.176653265953064,
  0.17738687992095947,
  0.21244320273399353,
  1.3741987943649292,
  0.15821929275989532,
  -0.29508981108665466,
  0.15550950169563293,
  0.6814433336257935,
  -0.5440629720687866,
  1.072876214981079,
  1.0310821533203125,
  -0.44354382157325745,
  0.2793634533882141,
  -0.6619238257408142,
  0.6959922313690186,
  0.41609808802604675,
  1.3100446462631226,
  -0.2585935890674591,
  0.6382582187652588,
  -0.3292795717716217,
  1.2015470266342163,
  -0.4622674882411957,
  -1.3622119426727295,
  0.35321205854415894,
  -0.32767558097839355,
  -1.4885005950927734,
  -0.042790476232767105,
  -0.38068845868110657,
  -0.8024241924285889,
  1.8672897815704346,
  -0.2906646430492401,
  0.17917092144489288,
  0.29951348900794983,
  0.8934911489486694,
  -1.289463758468628,
  1.1058218479156494,
  1.0139093399047852,
  1.0844438076019287,
  -0.0038699358701705933,
  -0.1477040946483612,
  -1.0480988025665283,
  0.7323204278945923,
  -2.608987331390381,
  -0.15572527050971985,
  0.18203328549861908,
  0.23022404313087463,
  1.9856657981872559,
  0.4256010949611664,
  -3.2760345935821533,
  0.0025287773460149765,
  -0.44158247113227844,
  1.7577197551727295,
  -0.257972776889801,
  1.1209932565689087,
  0.0021343454718589783,
  2.180934429168701,
  0.7309090495109558,
  -0.5872331857681274,
  0.653664231300354,
  0.2528747022151947,
  0.4397200345993042,
  2.0666868686676025,
  -0.07369418442249298,
  0.6473726630210876,
  -0.8478050231933594,
  0.7306411266326904,
  -0.8271400928497314,
  -0.7943285703659058,
  -1.6404656171798706,
  2.4173223972320557,
  -0.19000527262687683,
  -1.2386829853057861,
  -0.5105698704719543,
  -0.924028754234314,
  -1.9275240898132324,
  1.3092221021652222,
  1.0568927526474,
  -0.8227399587631226,
  0.8739662766456604,
  -0.8961621522903442,
  0.05641985684633255,
  -0.17874988913536072,
  0.18749524652957916,
  -1.4533231258392334,
  -1.0818108320236206,
  -1.28984797000885,
  -0.15099747478961945,
  0.0027224458754062653,
  0.08262927830219269,
  -0.4399411678314209,
  0.3624599277973175,
  -0.6026498079299927,
  -0.8819885849952698,
  -1.6534063816070557,
  0.7488142848014832,
  -0.49156099557876587,
  -1.0897676944732666,
  -2.73345947265625,
  -0.6390168070793152,
  -0.2175721824169159,
  -0.9972476363182068,
  -0.4033828675746918,
  -0.6583819389343262,
  0.2150110900402069,
  2.965780258178711,
  -0.21930131316184998,
  1.6080384254455566,
  2.0252859592437744,
  0.9709938764572144,
  -1.1863458156585693,
  -0.9457880258560181,
  -1.985852599143982,
  -1.0547881126403809,
  -0.1447194516658783,
  1.4204373359680176,
  0.7865580916404724,
  -1.1852742433547974,
  0.7166091203689575,
  -0.2496117502450943,
  0.7502471804618835,
  -1.0103986263275146,
  2.0195279121398926,
  -1.0223921537399292    };
    
    inserir_na_arvore(&arv, criar_registro(vetor1, "a"));
    inserir_na_arvore(&arv, criar_registro(vetor2, "b"));
    inserir_na_arvore(&arv, criar_registro(vetor3, "c"));
    inserir_na_arvore(&arv, criar_registro(vetor4, "d"));
    inserir_na_arvore(&arv, criar_registro(vetor5, "e"));
    inserir_na_arvore(&arv, criar_registro(vetor6, "f"));
    
    No *raiz = arv.raiz;
    assert(strcmp(((Registro *)raiz->direita->dado)->nome, "b") == 0);
    assert(strcmp(((Registro *)raiz->esquerda->dado)->nome, "e") == 0);
    assert(strcmp(((Registro *)raiz->direita->esquerda->dado)->nome, "c") == 0);
    assert(strcmp(((Registro *)raiz->direita->esquerda->direita->dado)->nome, "d") == 0);
    
    Registro *atual = criar_registro(vetor7, "x");
    Registro resultado = buscar_vizinho_mais_proximo(&arv, *atual);
    assert(strcmp(resultado.nome, "e") == 0);
    
    memcpy(atual->vetor, vetor1, TAM_VETOR);
    resultado = buscar_vizinho_mais_proximo(&arv, *atual);
    assert(strcmp(resultado.nome, "a") == 0);
    
    memcpy(atual->vetor, vetor4, TAM_VETOR);
    resultado = buscar_vizinho_mais_proximo(&arv, *atual);
    assert(strcmp(resultado.nome, "e") == 0);
    
    memcpy(atual->vetor, vetor6, TAM_VETOR);
    resultado = buscar_vizinho_mais_proximo(&arv, *atual);
    assert(strcmp(resultado.nome, "e") == 0);
    
    free(atual);
    liberar_arvore(&arv);
}

/* Implementação Global */
ArvoreKD arvore_global;

ArvoreKD* obter_arvore() {
    return &arvore_global;
}

void inserir_ponto(Registro p) {
    Registro *novo = malloc(sizeof(Registro));
    *novo = p;
    inserir_na_arvore(&arvore_global, novo);
}

void inicializar_arvore() {
    construir_arvore(&arvore_global, comparar_registros, 
                    calcular_distancia, 2);
}

int main() {
    testar_construcao();
    testar_busca();
    
    printf("Todos os testes passaram com sucesso!\n");
    return 0;
}